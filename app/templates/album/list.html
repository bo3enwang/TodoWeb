{% extends 'base.html' %}
{% block csscontent %}
    <link href="{{ url_for('.static', filename = 'css/fileinput.min.css') }}" rel="stylesheet">
    <style>
        .bootstrap-tagsinput {
            display: block;
            width: 100%;
        }

    </style>
{% endblock %}
{% block sidebar %}
    <li id="nav_todo" class="treeview">
        <a href="/admin/todo/p">
            <span>待办事项</span>
        </a>
    </li>
    <li id="nav_p" class="treeview">
        <a href="/admin/project/p/progress">
            <span>我的计划</span></i>
        </a>
        <ul class="treeview-menu">
            <li id="nav_p_progress">
                <a href="/admin/project/p/progress">进行中</a>
            </li>
            <li id="nav_p_start"><a href="/admin/project/p/start"> 未激活</a></li>
            <li id="nav_p_end"><a href="/admin/project/p/end"> 已完成</a></li>
        </ul>
    </li>
    <li id="nav_todo" class="treeview">
        <a href="/admin/post/list">
            <span>博客文章</span>
        </a>
    </li>
    <li id="nav_todo" class="treeview active">
        <a href="/admin/album/list">
            <span>图片管理</span>
        </a>
    </li>
{% endblock %}
{% block content %}
    <section class="content-header">
        <h1>
            图片管理
            <small>Control panel</small>
        </h1>
        <ol class="breadcrumb">
            <li><a href="#"><i class="fa fa-dashboard"></i> Home</a></li>
            <li class="active">图片管理</li>
        </ol>
    </section>

    <!-- Main content -->
    <section class="content">
        <div class="row">
            <div class="col-xs-12">
                <div class="box box-info">
                    <div class="box-header">
                        <div id="btn-group-type" class="btn-group .btn-group-sm" role="group" aria-label="...">

                        </div>

                        <div class="box-tools">
                            <a class="btn btn-sm btn-default" href="/admin/album/add">
                                新增图片
                            </a>
                        </div>
                    </div>
                    <!-- /.box-header -->
                    <div id="project-box" class="box-body no-padding">
                        <table class="table table-bordered table-striped">
                            <thead>
                            <tr>
                                <th style="width: 18%">图片名</th>
                                <th style="width: 30%">地址</th>
                                <th style="width: 22%">创建日期</th>
                                <th style="width: 6%">类型</th>
                                <th style="width: 15%">操作</th>
                            </tr>
                            </thead>
                            <tbody>
                            {% for album in albums %}
                                <tr>
                                    <td>{{ album.img_name }}</td>
                                    <td><p>{{ album.img_url }}</p></td>
                                    <td>{{ album.upload_date }}</td>
                                    <td>{% if album.type == 0 %}
                                        私有
                                    {% elif album.type ==1 %}
                                        公开
                                    {% endif %} </td>
                                    <td>
                                        <button type="button" class="btn btn-default btn-xs p-delete"
                                                data-imgurl="{{ album.img_url }}"
                                                data-toggle="modal"
                                                data-target="#imgView">
                                            <span class="glyphicon glyphicon-zoom-in" aria-hidden="true"></span> 预览
                                        </button>

                                        <button type="button" class="btn btn-default btn-xs a-delete"
                                                albumid="{{ album.id }}">
                                            <span class="glyphicon glyphicon-remove" aria-hidden="true"></span> 删除
                                        </button>
                                    </td>

                                </tr>
                            {% endfor %}

                            </tbody>
                        </table>
                    </div>
                </div>
                <!-- /.box -->
            </div>
        </div>
    </section>
    <!-- Modal -->
    <div class="modal fade" id="imgView" tabindex="-1" role="dialog" aria-labelledby="imgLabel">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
                            aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title" id="imgLabel">图片预览</h4>
                </div>
                <div class="modal-body">
                    <img id="modalImage">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
                </div>
            </div>
        </div>
    </div>


{% endblock %}
{% block jscontent %}
    <script>
        $(document).ready(function () {
            confirmAdd();
            modal_img_url();
        });
    </script>

    {% with messages = get_flashed_messages() %}
        {% if messages %}
            {% for message in messages %}
                <script>
                    $(document).ready(function () {
                        albumInfoMessage();
                    });

                    function albumInfoMessage() {
                        $.globalMessenger().post({
                            message: '{{ message }}',
                            type: 'info',
                            showCloseButton: true
                        });
                    }
                </script>
            {% endfor %}
        {% endif %}
    {% endwith %}
    <script>
        function confirmAdd() {
            $(".a-delete").confirm({
                text: "确定要删除图片?",
                title: "删除图片",
                confirm: function (button) {
                    albumid = button.attr("albumid");
                    $.ajax({
                        type: 'post',
                        contentType: "application/json; charset=UTF-8",
                        url: '/admin/album/' + albumid + '/delete/',
                        dataType: 'json',
                        error: function (xhr, err) {
                            console.log('请求错误' + err + '原因')
                        },
                        success: function (data, textStatus) {
                            if (data.success) {
                                if (data.redirect_url) {
                                    window.location.href = data.redirect_url;
                                } else if (data.reload) {
                                    window.location.reload();
                                }
                            } else {
                                $.globalMessenger().post({
                                    message: '删除失败',
                                    type: 'info',
                                    showCloseButton: true
                                });
                            }
                        }
                    });
                },
                cancel: function (button) {
                    // nothing to do
                },
                confirmButton: "确定",
                cancelButton: "取消",
                post: true,
                confirmButtonClass: "btn-danger",
                cancelButtonClass: "btn-default",
                dialogClass: "modal-dialog modal-xs" // Bootstrap classes for large modal
            });
        }
        function modal_img_url() {
            $('#imgView').on('show.bs.modal', function (event) {
                var button = $(event.relatedTarget); // Button that triggered the modal
                var imgurl = button.data('imgurl'); // Extract info from data-* attributes
                // If necessary, you could initiate an AJAX request here (and then do the updating in a callback).
                // Update the modal's content. We'll use jQuery here, but you could use a data binding library or other methods instead.
                var modal = $(this);
                modal.find('#modalImage').attr('src', imgurl);
                modal.find('#modalImage').css('max-width', "99%");
            })
        }

    </script>
{% endblock %}
