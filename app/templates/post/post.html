{% extends 'base.html' %}

{% block sidebar %}
    <li id="nav_todo" class="treeview">
        <a href="/admin/todo/p">
            <span>待办事项</span>
        </a>
    </li>
    <li id="nav_p" class="treeview">
        <a href="/admin/project/p/progress">
            <span>我的计划</span></i>
        </a>
        <ul class="treeview-menu">
            <li id="nav_p_progress">
                <a href="/admin/project/p/progress">进行中</a>
            </li>
            <li id="nav_p_start"><a href="/admin/project/p/start"> 未激活</a></li>
            <li id="nav_p_end"><a href="/admin/project/p/end"> 已完成</a></li>
        </ul>
    </li>
    <li id="nav_todo" class="treeview active">
        <a href="/admin/post/list">
            <span>博客文章</span>
        </a>
    </li>
    <li id="nav_todo" class="treeview">
        <a href="/admin/album/list">
            <span>图片管理</span>
        </a>
    </li>
{% endblock %}
{% block content %}
    <section class="content-header">
        <h1>
            博客文章
            <small>Control panel</small>
        </h1>
        <ol class="breadcrumb">
            <li><a href="#"><i class="fa fa-dashboard"></i> Home</a></li>
            <li class="active">博客文章</li>
        </ol>
    </section>

    <!-- Main content -->
    <section class="content">
        <div class="row">
            <div class="col-xs-12">
                <div class="box">
                    <div class="box-header">
                        <div id="btn-group-type" class="btn-group .btn-group-sm" role="group" aria-label="...">

                        </div>

                        <div class="box-tools">
                            <a class="btn btn-sm btn-default" href="/admin/post/add">
                                新增文章
                            </a>
                        </div>
                    </div>
                    <!-- /.box-header -->
                    <div id="project-box" class="box-body no-padding">
                        <table class="table table-bordered table-striped">
                            <thead>
                            <tr>
                                <th style="width: 40%">标题</th>
                                <th style="width: 20%">创建日期</th>
                                <th style="width: 25%">标签</th>
                                <th style="width: 15%">操作</th>
                            </tr>
                            </thead>
                            <tbody>
                            {% for post in posts %}
                                <tr>
                                    <td>{{ post.title }}</td>
                                    <td>{{ post.date_created }}</td>
                                    <td>{{ post.tags }}</td>
                                    <td>
                                        <a type="button" class="btn btn-default btn-xs"
                                           href="{{ url_for('post.post_edit', post_id=post.id) }}">
                                            <span class="glyphicon glyphicon-star" aria-hidden="true"></span> 编辑
                                        </a>
                                        <button type="button" class="btn btn-default btn-xs p-delete"
                                                postid="{{ post.id }}">
                                            <span class="glyphicon glyphicon-star" aria-hidden="true"></span> 删除
                                        </button>
                                    </td>

                                </tr>
                            {% endfor %}

                            </tbody>
                        </table>
                    </div>
                    <!-- /.box-body -->
                </div>
                <!-- /.box -->
            </div>
        </div>
    </section>



{% endblock %}
{% block jscontent %}
    <script>
        $(document).ready(function () {
            confirmAdd();
        });
    </script>

    {% with messages = get_flashed_messages() %}
        {% if messages %}
            {% for message in messages %}
                <script>
                    $(document).ready(function () {
                        postInfoMessage
                    });
                    function postInfoMessage() {
                        $.globalMessenger().post({
                            message: '{{ message }}',
                            type: 'info',
                            showCloseButton: true
                        });
                    }
                </script>
            {% endfor %}
        {% endif %}
    {% endwith %}
    <script>
        function confirmAdd() {
            $(".p-delete").confirm({
                text: "确定要删除文章?",
                title: "删除文章",
                confirm: function (button) {
                    postid = button.attr("postid");
                    console.log()
                    $.ajax({
                        type: 'post',
                        contentType: "application/json; charset=UTF-8",
                        url: '/admin/post/' + postid + '/delete/',
                        dataType: 'json',
                        error: function (xhr, err) {
                            console.log('请求错误' + err + '原因')
                        },
                        success: function (data, textStatus) {
                            if (data.success) {
                                if (data.redirect_url) {
                                    window.location.href = data.redirect_url;
                                } else if (data.reload) {
                                    window.location.reload();
                                }
                            } else {
                                $.globalMessenger().post({
                                    message: '删除失败',
                                    type: 'info',
                                    showCloseButton: true
                                });
                            }
                        }
                    });
                },
                cancel: function (button) {
                    // nothing to do
                },
                confirmButton: "确定",
                cancelButton: "取消",
                post: true,
                confirmButtonClass: "btn-danger",
                cancelButtonClass: "btn-default",
                dialogClass: "modal-dialog modal-xs" // Bootstrap classes for large modal
            });
        }

    </script>
{% endblock %}
